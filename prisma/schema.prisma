// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE MODELS - Multi-Tenant Foundation
// ============================================

// Organization (Tenant) - Core of multi-tenancy
model Organization {
  id          String   @id @default(cuid())
  clerkOrgId  String   @unique // Clerk organization ID
  name        String
  slug        String   @unique
  logo        String?
  website     String?
  industry    String?
  currency    String   @default("USD")
  timezone    String   @default("UTC")
  status      String   @default("ACTIVE") // ACTIVE, SUSPENDED, DELETED
  plan        String   @default("STARTER") // STARTER, PROFESSIONAL, ENTERPRISE
  enabledModules     String[] @default(["FINANCE", "CRM", "SALES", "INVENTORY"])
  onboardingComplete Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  auditLogs     AuditLog[]
  accounts      Account[]
  customers     Customer[]
  vendors       Vendor[]
  invoices      Invoice[]
  bills         Bill[]
  payments      Payment[]
  employees     Employee[]
  contacts      Contact[]
  leads         Lead[]
  opportunities Opportunity[]
  activities    Activity[]
  salesOrders   SalesOrder[]
  deliveries    Delivery[]
  returns       Return[]
  products      Product[]
  warehouses    Warehouse[]
  stockLevels   StockLevel[]
  stockMovements StockMovement[]
  purchaseOrders PurchaseOrder[]
  goodsReceipts  GoodsReceipt[]
  leaveRequests  LeaveRequest[]
  timesheets     Timesheet[]
  payrollRecords PayrollRecord[]
  assets         Asset[]
  projects       Project[]
  documents      Document[]
  billOfMaterials BillOfMaterials[]
  workOrders     WorkOrder[]
  onlineStores   OnlineStore[]

  @@index([clerkOrgId])
  @@index([status])
}

// Audit Log - Comprehensive audit trail for all operations
model AuditLog {
  id             String   @id @default(cuid())
  organizationId String
  userId         String   // Clerk user ID
  action         String   // CREATE, UPDATE, DELETE, READ
  entityType     String   // Table name (e.g., "Invoice", "Customer")
  entityId       String   // Record ID
  oldValues      Json?    // Previous state (for UPDATE/DELETE)
  newValues      Json?    // New state (for CREATE/UPDATE)
  ipAddress      String?
  userAgent      String?
  timestamp      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([timestamp])
  @@index([entityType, entityId])
}

// ============================================
// FINANCE & ACCOUNTING MODELS
// ============================================

// Chart of Accounts
model Account {
  id             String   @id @default(cuid())
  organizationId String
  accountNumber  String
  accountName    String
  accountType    String   // ASSET, LIABILITY, EQUITY, REVENUE, EXPENSE
  parentId       String?
  balance        Decimal  @default(0) @db.Decimal(15, 2)
  currency       String   @default("USD")
  isActive       Boolean  @default(true)
  description    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String
  updatedBy      String?
  deletedAt      DateTime?
  deletedBy      String?

  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parent       Account?          @relation("AccountHierarchy", fields: [parentId], references: [id])
  children     Account[]         @relation("AccountHierarchy")
  entries      TransactionEntry[]
  budgetItems  BudgetLineItem[]

  @@unique([organizationId, accountNumber])
  @@index([organizationId])
  @@index([accountType])
  @@index([deletedAt])
}

// General Ledger Transactions
model Transaction {
  id              String   @id @default(cuid())
  organizationId  String
  transactionDate DateTime
  description     String
  referenceNumber String?
  totalAmount     Decimal  @db.Decimal(15, 2)
  status          String   @default("POSTED") // DRAFT, POSTED, VOID
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String
  updatedBy       String?
  deletedAt       DateTime?
  deletedBy       String?

  entries TransactionEntry[]

  @@index([organizationId])
  @@index([transactionDate])
  @@index([status])
  @@index([deletedAt])
}

// Double-entry accounting entries
model TransactionEntry {
  id            String  @id @default(cuid())
  transactionId String
  accountId     String
  debit         Decimal @default(0) @db.Decimal(15, 2)
  credit        Decimal @default(0) @db.Decimal(15, 2)
  description   String?

  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  account     Account     @relation(fields: [accountId], references: [id])

  @@index([transactionId])
  @@index([accountId])
}

// ============================================
// CRM MODELS
// ============================================

// Customer
model Customer {
  id             String   @id @default(cuid())
  organizationId String
  customerNumber String
  companyName    String
  contactPerson  String?
  email          String
  phone          String?
  website        String?
  address        String?
  city           String?
  state          String?
  country        String?
  postalCode     String?
  taxId          String?
  status         String   @default("ACTIVE") // ACTIVE, INACTIVE
  customerType   String   @default("BUSINESS") // INDIVIDUAL, BUSINESS
  creditLimit    Decimal? @default(0) @db.Decimal(15, 2)
  paymentTerms   String?  // NET_30, NET_60, IMMEDIATE
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String
  updatedBy      String?
  deletedAt      DateTime?
  deletedBy      String?

  organization Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoices     Invoice[]
  contacts     Contact[]
  opportunities Opportunity[]
  activities   Activity[]
  salesOrders  SalesOrder[]
  returns      Return[]

  @@unique([organizationId, customerNumber])
  @@index([organizationId])
  @@index([status])
  @@index([deletedAt])
}

// Vendor
model Vendor {
  id             String   @id @default(cuid())
  organizationId String
  vendorNumber   String
  companyName    String
  contactPerson  String?
  email          String
  phone          String?
  address        String?
  city           String?
  state          String?
  country        String?
  taxId          String?
  paymentTerms   String?
  status         String   @default("ACTIVE")
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String
  updatedBy      String?
  deletedAt      DateTime?
  deletedBy      String?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  bills        Bill[]
  purchaseOrders PurchaseOrder[]

  @@unique([organizationId, vendorNumber])
  @@index([organizationId])
  @@index([status])
  @@index([deletedAt])
}

// ============================================
// INVOICES & BILLS
// ============================================

// Invoices (Accounts Receivable)
model Invoice {
  id             String   @id @default(cuid())
  organizationId String
  invoiceNumber  String
  customerId     String
  invoiceDate    DateTime
  dueDate        DateTime
  subtotal       Decimal  @db.Decimal(15, 2)
  taxAmount      Decimal  @default(0) @db.Decimal(15, 2)
  discountAmount Decimal  @default(0) @db.Decimal(15, 2)
  totalAmount    Decimal  @db.Decimal(15, 2)
  paidAmount     Decimal  @default(0) @db.Decimal(15, 2)
  status         String   @default("DRAFT") // DRAFT, SENT, PAID, OVERDUE, VOID
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String
  updatedBy      String?
  deletedAt      DateTime?
  deletedBy      String?

  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customer     Customer          @relation(fields: [customerId], references: [id])
  lineItems    InvoiceLineItem[]
  payments     Payment[]         @relation("InvoicePayments")

  @@unique([organizationId, invoiceNumber])
  @@index([organizationId])
  @@index([customerId])
  @@index([status])
  @@index([dueDate])
  @@index([deletedAt])
}

model InvoiceLineItem {
  id          String  @id @default(cuid())
  invoiceId   String
  description String
  quantity    Decimal @db.Decimal(15, 4)
  unitPrice   Decimal @db.Decimal(15, 2)
  taxRate     Decimal @default(0) @db.Decimal(5, 2)
  amount      Decimal @db.Decimal(15, 2)

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

// Bills (Accounts Payable)
model Bill {
  id             String   @id @default(cuid())
  organizationId String
  billNumber     String
  vendorId       String
  billDate       DateTime
  dueDate        DateTime
  subtotal       Decimal  @db.Decimal(15, 2)
  taxAmount      Decimal  @default(0) @db.Decimal(15, 2)
  totalAmount    Decimal  @db.Decimal(15, 2)
  paidAmount     Decimal  @default(0) @db.Decimal(15, 2)
  status         String   @default("DRAFT") // DRAFT, APPROVED, PAID, OVERDUE, VOID
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String
  updatedBy      String?
  deletedAt      DateTime?
  deletedBy      String?

  organization Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  vendor       Vendor         @relation(fields: [vendorId], references: [id])
  lineItems    BillLineItem[]
  payments     Payment[]      @relation("BillPayments")

  @@unique([organizationId, billNumber])
  @@index([organizationId])
  @@index([vendorId])
  @@index([status])
  @@index([deletedAt])
}

model BillLineItem {
  id          String  @id @default(cuid())
  billId      String
  description String
  quantity    Decimal @db.Decimal(15, 4)
  unitPrice   Decimal @db.Decimal(15, 2)
  taxRate     Decimal @default(0) @db.Decimal(5, 2)
  amount      Decimal @db.Decimal(15, 2)

  bill Bill @relation(fields: [billId], references: [id], onDelete: Cascade)

  @@index([billId])
}

// Payments
model Payment {
  id              String   @id @default(cuid())
  organizationId  String
  paymentNumber   String
  paymentDate     DateTime
  amount          Decimal  @db.Decimal(15, 2)
  paymentMethod   String   // CASH, CHECK, CREDIT_CARD, BANK_TRANSFER
  referenceNumber String?
  notes           String?
  invoiceId       String?
  billId          String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String
  updatedBy       String?
  deletedAt       DateTime?
  deletedBy       String?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoice      Invoice?     @relation("InvoicePayments", fields: [invoiceId], references: [id])
  bill         Bill?        @relation("BillPayments", fields: [billId], references: [id])

  @@unique([organizationId, paymentNumber])
  @@index([organizationId])
  @@index([invoiceId])
  @@index([billId])
  @@index([deletedAt])
}

// ============================================
// BUDGET MODELS
// ============================================

model Budget {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  fiscalYear     Int
  startDate      DateTime
  endDate        DateTime
  totalAmount    Decimal  @db.Decimal(15, 2)
  status         String   @default("DRAFT") // DRAFT, ACTIVE, CLOSED
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String
  updatedBy      String?
  deletedAt      DateTime?
  deletedBy      String?

  lineItems BudgetLineItem[]

  @@index([organizationId])
  @@index([fiscalYear])
  @@index([deletedAt])
}

model BudgetLineItem {
  id        String  @id @default(cuid())
  budgetId  String
  accountId String
  amount    Decimal @db.Decimal(15, 2)
  period    String  // MONTHLY, QUARTERLY, ANNUAL

  budget  Budget  @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  account Account @relation(fields: [accountId], references: [id])

  @@index([budgetId])
  @@index([accountId])
}

// ============================================
// HR & PAYROLL MODELS
// ============================================

model Employee {
  id              String    @id @default(cuid())
  organizationId  String
  clerkUserId     String?   // Link to Clerk user for self-service
  employeeNumber  String
  firstName       String
  lastName        String
  email           String
  phone           String?
  dateOfBirth     DateTime?
  hireDate        DateTime
  terminationDate DateTime?
  department      String?
  position        String
  employmentType  String    // FULL_TIME, PART_TIME, CONTRACT
  status          String    @default("ACTIVE") // ACTIVE, INACTIVE, TERMINATED
  salary          Decimal?  @db.Decimal(15, 2)
  currency        String    @default("USD")
  payFrequency    String?   // WEEKLY, BI_WEEKLY, MONTHLY
  managerId       String?
  // Self-service fields
  address         String?
  emergencyContactName  String?
  emergencyContactPhone String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  createdBy       String
  updatedBy       String?
  deletedAt       DateTime?
  deletedBy       String?

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  manager         Employee?    @relation("EmployeeManager", fields: [managerId], references: [id])
  directReports   Employee[]   @relation("EmployeeManager")
  leaveRequests   LeaveRequest[]
  timesheets      Timesheet[]
  payrollRecords  PayrollRecord[]
  certifications  EmployeeCertification[]
  dependants      EmployeeDependant[]
  bankDetails     EmployeeBankDetails?
  resignations    ResignationRequest[]

  @@unique([organizationId, employeeNumber])
  @@unique([organizationId, clerkUserId])
  @@index([organizationId])
  @@index([clerkUserId])
  @@index([status])
  @@index([department])
  @@index([deletedAt])
}

// Leave Request - Employee time off
model LeaveRequest {
  id             String    @id @default(cuid())
  organizationId String
  employeeId     String
  leaveType      String    // ANNUAL, SICK, UNPAID, MATERNITY, PATERNITY, OTHER
  startDate      DateTime
  endDate        DateTime
  totalDays      Decimal   @db.Decimal(5, 1)
  status         String    @default("PENDING") // PENDING, APPROVED, REJECTED, CANCELLED
  reason         String?
  approvedBy     String?
  approvedAt     DateTime?
  rejectionReason String?
  notes          String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  createdBy      String

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  employee     Employee     @relation(fields: [employeeId], references: [id])

  @@index([organizationId])
  @@index([employeeId])
  @@index([status])
  @@index([startDate])
}

// Timesheet - Track employee hours
model Timesheet {
  id             String   @id @default(cuid())
  organizationId String
  employeeId     String
  weekStartDate  DateTime
  status         String   @default("DRAFT") // DRAFT, SUBMITTED, APPROVED, REJECTED
  totalHours     Decimal  @default(0) @db.Decimal(6, 2)
  overtimeHours  Decimal  @default(0) @db.Decimal(6, 2)
  notes          String?
  submittedAt    DateTime?
  approvedBy     String?
  approvedAt     DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String

  organization Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  employee     Employee        @relation(fields: [employeeId], references: [id])
  entries      TimesheetEntry[]

  @@unique([employeeId, weekStartDate])
  @@index([organizationId])
  @@index([employeeId])
  @@index([status])
  @@index([weekStartDate])
}

// Timesheet Entry - Daily time entries
model TimesheetEntry {
  id           String   @id @default(cuid())
  timesheetId  String
  date         DateTime
  hoursWorked  Decimal  @db.Decimal(5, 2)
  description  String?
  project      String?

  timesheet Timesheet @relation(fields: [timesheetId], references: [id], onDelete: Cascade)

  @@index([timesheetId])
  @@index([date])
}

// Payroll Record - Monthly/period payroll
model PayrollRecord {
  id             String   @id @default(cuid())
  organizationId String
  employeeId     String
  payPeriodStart DateTime
  payPeriodEnd   DateTime
  status         String   @default("DRAFT") // DRAFT, PROCESSING, APPROVED, PAID
  baseSalary     Decimal  @db.Decimal(15, 2)
  overtimePay    Decimal  @default(0) @db.Decimal(15, 2)
  bonus          Decimal  @default(0) @db.Decimal(15, 2)
  deductions     Decimal  @default(0) @db.Decimal(15, 2)
  taxWithheld    Decimal  @default(0) @db.Decimal(15, 2)
  netPay         Decimal  @db.Decimal(15, 2)
  currency       String   @default("USD")
  notes          String?
  paidAt         DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String
  approvedBy     String?
  approvedAt     DateTime?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  employee     Employee     @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, payPeriodStart, payPeriodEnd])
  @@index([organizationId])
  @@index([employeeId])
  @@index([status])
  @@index([payPeriodStart])
}

// ============================================
// EMPLOYEE SELF-SERVICE MODELS
// ============================================

// Employee Certification - Degrees, certifications, skills
model EmployeeCertification {
  id           String    @id @default(cuid())
  employeeId   String
  name         String    // e.g., "AWS Solutions Architect", "MBA"
  type         String    // CERTIFICATION, DEGREE, SKILL, LICENSE
  issuer       String?   // e.g., "Amazon", "Harvard University"
  issueDate    DateTime?
  expiryDate   DateTime?
  credentialId String?   // Credential/license number
  documentUrl  String?   // Link to certificate/diploma
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([type])
}

// Employee Dependant - Family members for benefits
model EmployeeDependant {
  id           String    @id @default(cuid())
  employeeId   String
  firstName    String
  lastName     String
  relationship String    // SPOUSE, CHILD, PARENT, OTHER
  dateOfBirth  DateTime?
  gender       String?   // MALE, FEMALE, OTHER
  isEmergencyContact Boolean @default(false)
  phone        String?
  notes        String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
}

// Employee Bank Details - For salary payments
model EmployeeBankDetails {
  id            String   @id @default(cuid())
  employeeId    String   @unique  // One bank account per employee
  bankName      String
  accountName   String   // Name on the account
  accountNumber String
  routingNumber String?  // For US banks
  swiftCode     String?  // For international transfers
  branchCode    String?
  accountType   String   @default("CHECKING") // CHECKING, SAVINGS
  isPrimary     Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
}

// Resignation Request - Employee resignation workflow
model ResignationRequest {
  id              String    @id @default(cuid())
  organizationId  String
  employeeId      String
  requestDate     DateTime  @default(now())
  lastWorkingDate DateTime
  reason          String?
  status          String    @default("PENDING") // PENDING, APPROVED, REJECTED, WITHDRAWN
  notes           String?
  approvedBy      String?
  approvedAt      DateTime?
  rejectionReason String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([organizationId])
  @@index([status])
}

// ============================================
// CRM MODELS - Leads, Opportunities, Activities
// ============================================

// Contact - Individual contacts (can be linked to customers)
model Contact {
  id             String   @id @default(cuid())
  organizationId String
  customerId     String?
  firstName      String
  lastName       String
  email          String
  phone          String?
  mobile         String?
  position       String?
  department     String?
  isPrimary      Boolean  @default(false)
  status         String   @default("ACTIVE") // ACTIVE, INACTIVE
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String
  updatedBy      String?
  deletedAt      DateTime?
  deletedBy      String?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customer     Customer?    @relation(fields: [customerId], references: [id])
  leads        Lead[]
  activities   Activity[]

  @@index([organizationId])
  @@index([customerId])
  @@index([email])
  @@index([deletedAt])
}

// Lead - Sales leads/prospects
model Lead {
  id             String    @id @default(cuid())
  organizationId String
  leadNumber     String
  companyName    String?
  contactId      String?
  firstName      String
  lastName       String
  email          String
  phone          String?
  source         String    // WEBSITE, REFERRAL, COLD_CALL, EMAIL, TRADE_SHOW, OTHER
  status         String    @default("NEW") // NEW, CONTACTED, QUALIFIED, UNQUALIFIED, CONVERTED
  rating         String?   // HOT, WARM, COLD
  industry       String?
  estimatedValue Decimal?  @db.Decimal(15, 2)
  notes          String?
  assignedTo     String?   // Clerk user ID
  convertedAt    DateTime?
  convertedToCustomerId String?
  convertedToOpportunityId String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  createdBy      String
  updatedBy      String?
  deletedAt      DateTime?
  deletedBy      String?

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contact      Contact?      @relation(fields: [contactId], references: [id])
  activities   Activity[]

  @@unique([organizationId, leadNumber])
  @@index([organizationId])
  @@index([status])
  @@index([source])
  @@index([assignedTo])
  @@index([deletedAt])
}

// Opportunity - Sales opportunities/pipeline
model Opportunity {
  id             String   @id @default(cuid())
  organizationId String
  opportunityNumber String
  name           String
  customerId     String
  stage          String   @default("PROSPECTING") // PROSPECTING, QUALIFICATION, PROPOSAL, NEGOTIATION, CLOSED_WON, CLOSED_LOST
  probability    Int      @default(0) // 0-100%
  amount         Decimal  @db.Decimal(15, 2)
  currency       String   @default("USD")
  expectedCloseDate DateTime?
  actualCloseDate DateTime?
  source         String?  // LEAD, REFERRAL, EXISTING_CUSTOMER, OTHER
  leadId         String?  // If converted from lead
  description    String?
  notes          String?
  assignedTo     String?  // Clerk user ID
  lostReason     String?  // If CLOSED_LOST
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String
  updatedBy      String?
  deletedAt      DateTime?
  deletedBy      String?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customer     Customer     @relation(fields: [customerId], references: [id])
  activities   Activity[]

  @@unique([organizationId, opportunityNumber])
  @@index([organizationId])
  @@index([customerId])
  @@index([stage])
  @@index([assignedTo])
  @@index([expectedCloseDate])
  @@index([deletedAt])
}

// Activity - Track all CRM activities (calls, emails, meetings, tasks)
model Activity {
  id             String    @id @default(cuid())
  organizationId String
  type           String    // CALL, EMAIL, MEETING, TASK, NOTE
  subject        String
  description    String?
  dueDate        DateTime?
  completedAt    DateTime?
  status         String    @default("PENDING") // PENDING, COMPLETED, CANCELLED
  priority       String    @default("MEDIUM") // LOW, MEDIUM, HIGH
  duration       Int?      // Duration in minutes
  
  // Polymorphic relations
  leadId         String?
  opportunityId  String?
  customerId     String?
  contactId      String?
  
  assignedTo     String?   // Clerk user ID
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  createdBy      String
  updatedBy      String?
  deletedAt      DateTime?
  deletedBy      String?

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  lead         Lead?         @relation(fields: [leadId], references: [id])
  opportunity  Opportunity?  @relation(fields: [opportunityId], references: [id])
  customer     Customer?     @relation(fields: [customerId], references: [id])
  contact      Contact?      @relation(fields: [contactId], references: [id])

  @@index([organizationId])
  @@index([type])
  @@index([status])
  @@index([dueDate])
  @@index([leadId])
  @@index([opportunityId])
  @@index([customerId])
  @@index([contactId])
  @@index([assignedTo])
  @@index([deletedAt])
}

// ============================================
// SALES & DISTRIBUTION MODELS
// ============================================

// Sales Order - Customer orders
model SalesOrder {
  id              String   @id @default(cuid())
  organizationId  String
  orderNumber     String
  customerId      String
  orderDate       DateTime @default(now())
  expectedDeliveryDate DateTime?
  status          String   @default("DRAFT") // DRAFT, CONFIRMED, PROCESSING, SHIPPED, DELIVERED, CANCELLED
  paymentStatus   String   @default("UNPAID") // UNPAID, PARTIAL, PAID
  subtotal        Decimal  @db.Decimal(15, 2)
  taxAmount       Decimal  @default(0) @db.Decimal(15, 2)
  shippingAmount  Decimal  @default(0) @db.Decimal(15, 2)
  discountAmount  Decimal  @default(0) @db.Decimal(15, 2)
  totalAmount     Decimal  @db.Decimal(15, 2)
  currency        String   @default("USD")
  shippingAddress String?
  shippingCity    String?
  shippingState   String?
  shippingCountry String?
  shippingPostalCode String?
  notes           String?
  invoiceId       String?  // Link to generated invoice
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String
  updatedBy       String?
  deletedAt       DateTime?
  deletedBy       String?

  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customer     Customer          @relation(fields: [customerId], references: [id])
  lineItems    SalesOrderItem[]
  deliveries   Delivery[]
  returns      Return[]

  @@unique([organizationId, orderNumber])
  @@index([organizationId])
  @@index([customerId])
  @@index([status])
  @@index([orderDate])
  @@index([deletedAt])
}

// Sales Order Line Items
model SalesOrderItem {
  id            String  @id @default(cuid())
  salesOrderId  String
  description   String
  sku           String?
  quantity      Decimal @db.Decimal(15, 2)
  unitPrice     Decimal @db.Decimal(15, 2)
  taxRate       Decimal @default(0) @db.Decimal(5, 2)
  discountPercent Decimal @default(0) @db.Decimal(5, 2)
  lineTotal     Decimal @db.Decimal(15, 2)
  deliveredQty  Decimal @default(0) @db.Decimal(15, 2)
  returnedQty   Decimal @default(0) @db.Decimal(15, 2)

  salesOrder SalesOrder @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)

  @@index([salesOrderId])
}

// Delivery - Shipment tracking
model Delivery {
  id             String    @id @default(cuid())
  organizationId String
  deliveryNumber String
  salesOrderId   String
  deliveryDate   DateTime  @default(now())
  status         String    @default("PENDING") // PENDING, IN_TRANSIT, DELIVERED, FAILED
  carrier        String?
  trackingNumber String?
  shippingAddress String?
  shippingCity   String?
  shippingCountry String?
  notes          String?
  deliveredAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  createdBy      String
  updatedBy      String?
  deletedAt      DateTime?
  deletedBy      String?

  organization Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  salesOrder   SalesOrder       @relation(fields: [salesOrderId], references: [id])
  items        DeliveryItem[]

  @@unique([organizationId, deliveryNumber])
  @@index([organizationId])
  @@index([salesOrderId])
  @@index([status])
  @@index([deletedAt])
}

// Delivery Line Items
model DeliveryItem {
  id          String  @id @default(cuid())
  deliveryId  String
  description String
  sku         String?
  quantity    Decimal @db.Decimal(15, 2)

  delivery Delivery @relation(fields: [deliveryId], references: [id], onDelete: Cascade)

  @@index([deliveryId])
}

// Returns - Handle customer returns
model Return {
  id             String    @id @default(cuid())
  organizationId String
  returnNumber   String
  salesOrderId   String
  customerId     String
  returnDate     DateTime  @default(now())
  status         String    @default("PENDING") // PENDING, APPROVED, RECEIVED, REFUNDED, REJECTED
  reason         String    // DEFECTIVE, WRONG_ITEM, DAMAGED, NOT_SATISFIED, OTHER
  description    String?
  totalAmount    Decimal   @db.Decimal(15, 2)
  refundAmount   Decimal   @default(0) @db.Decimal(15, 2)
  refundMethod   String?   // ORIGINAL_PAYMENT, STORE_CREDIT, BANK_TRANSFER
  notes          String?
  approvedAt     DateTime?
  approvedBy     String?
  receivedAt     DateTime?
  refundedAt     DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  createdBy      String
  updatedBy      String?
  deletedAt      DateTime?
  deletedBy      String?

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  salesOrder   SalesOrder    @relation(fields: [salesOrderId], references: [id])
  customer     Customer      @relation(fields: [customerId], references: [id])
  items        ReturnItem[]

  @@unique([organizationId, returnNumber])
  @@index([organizationId])
  @@index([salesOrderId])
  @@index([customerId])
  @@index([status])
  @@index([deletedAt])
}

// Return Line Items
model ReturnItem {
  id          String  @id @default(cuid())
  returnId    String
  description String
  sku         String?
  quantity    Decimal @db.Decimal(15, 2)
  unitPrice   Decimal @db.Decimal(15, 2)
  lineTotal   Decimal @db.Decimal(15, 2)

  return Return @relation(fields: [returnId], references: [id], onDelete: Cascade)

  @@index([returnId])
}

// ============================================
// INVENTORY MANAGEMENT MODELS
// ============================================

// Product/Item - Items in inventory
model Product {
  id             String   @id @default(cuid())
  organizationId String
  sku            String
  name           String
  description    String?
  category       String?
  type           String   @default("PHYSICAL") // PHYSICAL, SERVICE, DIGITAL
  unit           String   @default("EACH") // EACH, KG, LB, L, M, etc.
  costPrice      Decimal  @default(0) @db.Decimal(15, 2)
  sellingPrice   Decimal  @default(0) @db.Decimal(15, 2)
  taxRate        Decimal  @default(0) @db.Decimal(5, 2)
  reorderLevel   Int      @default(0)
  reorderQuantity Int     @default(0)
  isActive       Boolean  @default(true)
  isSellable     Boolean  @default(true)
  isPurchasable  Boolean  @default(true)
  barcode        String?
  weight         Decimal? @db.Decimal(10, 3)
  dimensions     String?  // JSON: {length, width, height}
  imageUrl       String?
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String
  updatedBy      String?
  deletedAt      DateTime?
  deletedBy      String?

  organization  Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  stockLevels   StockLevel[]
  stockMovements StockMovement[]

  @@unique([organizationId, sku])
  @@index([organizationId])
  @@index([category])
  @@index([isActive])
  @@index([deletedAt])
}

// Warehouse - Storage locations
model Warehouse {
  id             String   @id @default(cuid())
  organizationId String
  code           String
  name           String
  address        String?
  city           String?
  state          String?
  country        String?
  postalCode     String?
  isDefault      Boolean  @default(false)
  isActive       Boolean  @default(true)
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String
  updatedBy      String?
  deletedAt      DateTime?
  deletedBy      String?

  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  stockLevels    StockLevel[]
  stockMovementsFrom StockMovement[] @relation("FromWarehouse")
  stockMovementsTo   StockMovement[] @relation("ToWarehouse")
  goodsReceipts  GoodsReceipt[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([isActive])
  @@index([deletedAt])
}

// Stock Level - Current inventory by product and warehouse
model StockLevel {
  id             String   @id @default(cuid())
  organizationId String
  productId      String
  warehouseId    String
  quantity       Decimal  @default(0) @db.Decimal(15, 2)
  reservedQty    Decimal  @default(0) @db.Decimal(15, 2) // Reserved for orders
  availableQty   Decimal  @default(0) @db.Decimal(15, 2) // quantity - reserved
  lastCountDate  DateTime?
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  product      Product      @relation(fields: [productId], references: [id])
  warehouse    Warehouse    @relation(fields: [warehouseId], references: [id])

  @@unique([productId, warehouseId])
  @@index([organizationId])
  @@index([productId])
  @@index([warehouseId])
}

// Stock Movement - Track inventory changes
model StockMovement {
  id             String   @id @default(cuid())
  organizationId String
  movementNumber String
  productId      String
  type           String   // IN, OUT, TRANSFER, ADJUSTMENT
  reason         String?  // PURCHASE, SALE, RETURN, DAMAGE, TRANSFER, COUNT_ADJUSTMENT
  quantity       Decimal  @db.Decimal(15, 2)
  fromWarehouseId String?
  toWarehouseId   String?
  referenceType  String?  // SALES_ORDER, PURCHASE_ORDER, RETURN, etc.
  referenceId    String?  // ID of the related document
  notes          String?
  movementDate   DateTime @default(now())
  createdAt      DateTime @default(now())
  createdBy      String

  organization  Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  product       Product      @relation(fields: [productId], references: [id])
  fromWarehouse Warehouse?   @relation("FromWarehouse", fields: [fromWarehouseId], references: [id])
  toWarehouse   Warehouse?   @relation("ToWarehouse", fields: [toWarehouseId], references: [id])

  @@unique([organizationId, movementNumber])
  @@index([organizationId])
  @@index([productId])
  @@index([type])
  @@index([movementDate])
}

// ============================================
// PROCUREMENT MODELS
// ============================================

// Purchase Order - Orders to vendors
model PurchaseOrder {
  id              String   @id @default(cuid())
  organizationId  String
  poNumber        String
  vendorId        String
  orderDate       DateTime @default(now())
  expectedDate    DateTime?
  status          String   @default("DRAFT") // DRAFT, SENT, CONFIRMED, PARTIAL, RECEIVED, CANCELLED
  subtotal        Decimal  @db.Decimal(15, 2)
  taxAmount       Decimal  @default(0) @db.Decimal(15, 2)
  shippingAmount  Decimal  @default(0) @db.Decimal(15, 2)
  totalAmount     Decimal  @db.Decimal(15, 2)
  currency        String   @default("USD")
  shippingAddress String?
  notes           String?
  billId          String?  // Link to generated bill
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String
  updatedBy       String?
  deletedAt       DateTime?
  deletedBy       String?

  organization  Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  vendor        Vendor                @relation(fields: [vendorId], references: [id])
  lineItems     PurchaseOrderItem[]
  goodsReceipts GoodsReceipt[]

  @@unique([organizationId, poNumber])
  @@index([organizationId])
  @@index([vendorId])
  @@index([status])
  @@index([orderDate])
  @@index([deletedAt])
}

// Purchase Order Line Items
model PurchaseOrderItem {
  id              String  @id @default(cuid())
  purchaseOrderId String
  productId       String?
  description     String
  sku             String?
  quantity        Decimal @db.Decimal(15, 2)
  unitPrice       Decimal @db.Decimal(15, 2)
  taxRate         Decimal @default(0) @db.Decimal(5, 2)
  lineTotal       Decimal @db.Decimal(15, 2)
  receivedQty     Decimal @default(0) @db.Decimal(15, 2)

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@index([purchaseOrderId])
}

// Goods Receipt - Receiving inventory from PO
model GoodsReceipt {
  id              String   @id @default(cuid())
  organizationId  String
  receiptNumber   String
  purchaseOrderId String
  warehouseId     String
  receiptDate     DateTime @default(now())
  status          String   @default("PENDING") // PENDING, INSPECTING, COMPLETED, REJECTED
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String
  updatedBy       String?

  organization  Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  purchaseOrder PurchaseOrder       @relation(fields: [purchaseOrderId], references: [id])
  warehouse     Warehouse           @relation(fields: [warehouseId], references: [id])
  items         GoodsReceiptItem[]

  @@unique([organizationId, receiptNumber])
  @@index([organizationId])
  @@index([purchaseOrderId])
  @@index([warehouseId])
  @@index([status])
}

// Goods Receipt Line Items
model GoodsReceiptItem {
  id             String  @id @default(cuid())
  goodsReceiptId String
  productId      String?
  description    String
  orderedQty     Decimal @db.Decimal(15, 2)
  receivedQty    Decimal @db.Decimal(15, 2)
  acceptedQty    Decimal @db.Decimal(15, 2)
  rejectedQty    Decimal @default(0) @db.Decimal(15, 2)
  notes          String?

  goodsReceipt GoodsReceipt @relation(fields: [goodsReceiptId], references: [id], onDelete: Cascade)

  @@index([goodsReceiptId])
}

// ============================================
// ASSET MANAGEMENT MODELS
// ============================================

model Asset {
  id               String    @id @default(cuid())
  organizationId   String
  assetNumber      String
  name             String
  description      String?
  category         String    // EQUIPMENT, VEHICLE, FURNITURE, IT, BUILDING
  location         String?
  purchaseDate     DateTime
  purchasePrice    Decimal   @db.Decimal(15, 2)
  currentValue     Decimal   @db.Decimal(15, 2)
  salvageValue     Decimal   @default(0) @db.Decimal(15, 2)
  usefulLifeMonths Int       @default(60)
  depreciationMethod String  @default("STRAIGHT_LINE") // STRAIGHT_LINE, DECLINING_BALANCE
  status           String    @default("ACTIVE") // ACTIVE, DISPOSED, UNDER_MAINTENANCE
  warrantyExpiry   DateTime?
  serialNumber     String?
  assignedTo       String?
  vendorId         String?
  notes            String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  createdBy        String
  updatedBy        String?
  deletedAt        DateTime?
  deletedBy        String?

  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  maintenanceRecords AssetMaintenance[]
  depreciationRecords AssetDepreciation[]

  @@unique([organizationId, assetNumber])
  @@index([organizationId])
  @@index([category])
  @@index([status])
  @@index([deletedAt])
}

model AssetMaintenance {
  id              String   @id @default(cuid())
  assetId         String
  maintenanceDate DateTime
  type            String   // PREVENTIVE, CORRECTIVE, INSPECTION
  description     String
  cost            Decimal  @default(0) @db.Decimal(15, 2)
  performedBy     String?
  nextScheduled   DateTime?
  notes           String?
  createdAt       DateTime @default(now())
  createdBy       String

  asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
  @@index([maintenanceDate])
}

model AssetDepreciation {
  id               String   @id @default(cuid())
  assetId          String
  period           DateTime
  depreciationAmount Decimal @db.Decimal(15, 2)
  accumulatedDepreciation Decimal @db.Decimal(15, 2)
  bookValue        Decimal  @db.Decimal(15, 2)
  createdAt        DateTime @default(now())
  createdBy        String

  asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@unique([assetId, period])
  @@index([assetId])
}

// ============================================
// PROJECT MANAGEMENT MODELS
// ============================================

model Project {
  id              String    @id @default(cuid())
  organizationId  String
  projectNumber   String
  name            String
  description     String?
  customerId      String?
  managerId       String?
  status          String    @default("PLANNING") // PLANNING, ACTIVE, ON_HOLD, COMPLETED, CANCELLED
  priority        String    @default("MEDIUM") // LOW, MEDIUM, HIGH, CRITICAL
  startDate       DateTime?
  endDate         DateTime?
  budget          Decimal?  @db.Decimal(15, 2)
  actualCost      Decimal   @default(0) @db.Decimal(15, 2)
  progress        Int       @default(0)
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  createdBy       String
  updatedBy       String?
  deletedAt       DateTime?
  deletedBy       String?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  tasks        ProjectTask[]
  resources    ProjectResource[]

  @@unique([organizationId, projectNumber])
  @@index([organizationId])
  @@index([status])
  @@index([deletedAt])
}

model ProjectTask {
  id          String    @id @default(cuid())
  projectId   String
  name        String
  description String?
  assigneeId  String?
  status      String    @default("TODO") // TODO, IN_PROGRESS, REVIEW, DONE
  priority    String    @default("MEDIUM")
  dueDate     DateTime?
  estimatedHours Decimal? @db.Decimal(6, 2)
  actualHours Decimal   @default(0) @db.Decimal(6, 2)
  parentId    String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdBy   String

  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parent      ProjectTask? @relation("TaskHierarchy", fields: [parentId], references: [id])
  subtasks    ProjectTask[] @relation("TaskHierarchy")

  @@index([projectId])
  @@index([status])
  @@index([assigneeId])
}

model ProjectResource {
  id          String   @id @default(cuid())
  projectId   String
  employeeId  String?
  resourceName String
  role        String?
  hoursAllocated Decimal @default(0) @db.Decimal(8, 2)
  hourlyRate  Decimal? @db.Decimal(10, 2)
  startDate   DateTime?
  endDate     DateTime?

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

// ============================================
// DOCUMENT MANAGEMENT MODELS
// ============================================

model Document {
  id              String   @id @default(cuid())
  organizationId  String
  title           String
  description     String?
  fileName        String
  fileType        String
  fileSize        Int
  filePath        String
  category        String?  // CONTRACT, INVOICE, REPORT, POLICY, OTHER
  tags            String?
  version         Int      @default(1)
  status          String   @default("ACTIVE") // ACTIVE, ARCHIVED, DELETED
  entityType      String?  // Related entity type (Customer, Vendor, etc)
  entityId        String?  // Related entity ID
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String
  updatedBy       String?

  organization Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  versions     DocumentVersion[]

  @@index([organizationId])
  @@index([category])
  @@index([entityType, entityId])
}

model DocumentVersion {
  id         String   @id @default(cuid())
  documentId String
  version    Int
  fileName   String
  filePath   String
  fileSize   Int
  notes      String?
  createdAt  DateTime @default(now())
  createdBy  String

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, version])
  @@index([documentId])
}

// ============================================
// MANUFACTURING MODELS
// ============================================

model BillOfMaterials {
  id              String   @id @default(cuid())
  organizationId  String
  bomNumber       String
  productId       String
  name            String
  version         Int      @default(1)
  status          String   @default("DRAFT") // DRAFT, ACTIVE, OBSOLETE
  effectiveDate   DateTime?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String
  updatedBy       String?

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  components   BOMComponent[]
  workOrders   WorkOrder[]

  @@unique([organizationId, bomNumber])
  @@index([organizationId])
  @@index([productId])
  @@index([status])
}

model BOMComponent {
  id          String  @id @default(cuid())
  bomId       String
  productId   String?
  description String
  quantity    Decimal @db.Decimal(15, 4)
  unit        String  @default("EACH")
  wastagePercent Decimal @default(0) @db.Decimal(5, 2)
  notes       String?

  bom BillOfMaterials @relation(fields: [bomId], references: [id], onDelete: Cascade)

  @@index([bomId])
}

model WorkOrder {
  id              String    @id @default(cuid())
  organizationId  String
  workOrderNumber String
  bomId           String?
  productId       String?
  quantity        Decimal   @db.Decimal(15, 2)
  status          String    @default("PLANNED") // PLANNED, IN_PROGRESS, COMPLETED, CANCELLED
  priority        String    @default("MEDIUM")
  plannedStart    DateTime?
  plannedEnd      DateTime?
  actualStart     DateTime?
  actualEnd       DateTime?
  completedQty    Decimal   @default(0) @db.Decimal(15, 2)
  scrapQty        Decimal   @default(0) @db.Decimal(15, 2)
  warehouseId     String?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  createdBy       String
  updatedBy       String?

  organization Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  bom          BillOfMaterials? @relation(fields: [bomId], references: [id])
  operations   WorkOrderOperation[]

  @@unique([organizationId, workOrderNumber])
  @@index([organizationId])
  @@index([status])
  @@index([bomId])
}

model WorkOrderOperation {
  id            String    @id @default(cuid())
  workOrderId   String
  operationNum  Int
  name          String
  description   String?
  workCenterId  String?
  plannedHours  Decimal   @default(0) @db.Decimal(6, 2)
  actualHours   Decimal   @default(0) @db.Decimal(6, 2)
  status        String    @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED
  startedAt     DateTime?
  completedAt   DateTime?

  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
}

// ============================================
// E-COMMERCE MODELS
// ============================================

model OnlineStore {
  id              String   @id @default(cuid())
  organizationId  String
  name            String
  slug            String
  description     String?
  logo            String?
  primaryColor    String   @default("#3B82F6")
  isActive        Boolean  @default(true)
  currency        String   @default("USD")
  shippingEnabled Boolean  @default(true)
  taxEnabled      Boolean  @default(true)
  // Payment Gateway Configuration
  paymentProvider String   @default("COD") // COD, STRIPE, PAYSTACK, FLUTTERWAVE, LEMONSQUEEZY
  stripePublicKey   String?
  stripeSecretKey   String?
  paystackPublicKey String?
  paystackSecretKey String?
  flutterwavePublicKey String?
  flutterwaveSecretKey String?
  lemonSqueezyApiKey   String?
  lemonSqueezyStoreId  String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String

  organization    Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  products        OnlineProduct[]
  orders          OnlineOrder[]
  categories      OnlineCategory[]

  @@unique([organizationId, slug])
  @@index([organizationId])
}

model OnlineCategory {
  id          String  @id @default(cuid())
  storeId     String
  name        String
  slug        String
  description String?
  parentId    String?
  sortOrder   Int     @default(0)
  isActive    Boolean @default(true)

  store    OnlineStore       @relation(fields: [storeId], references: [id], onDelete: Cascade)
  parent   OnlineCategory?   @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children OnlineCategory[]  @relation("CategoryHierarchy")
  products OnlineProduct[]

  @@unique([storeId, slug])
  @@index([storeId])
}

model OnlineProduct {
  id              String   @id @default(cuid())
  storeId         String
  productId       String?  // Link to inventory Product
  categoryId      String?
  name            String
  slug            String
  description     String?
  shortDescription String?
  price           Decimal  @db.Decimal(15, 2)
  compareAtPrice  Decimal? @db.Decimal(15, 2)
  images          String?  // JSON array of image URLs
  isActive        Boolean  @default(true)
  isFeatured      Boolean  @default(false)
  stockTracking   Boolean  @default(true)
  stockQuantity   Int      @default(0)
  lowStockThreshold Int    @default(5)
  sortOrder       Int      @default(0)
  seoTitle        String?
  seoDescription  String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  store    OnlineStore     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  category OnlineCategory? @relation(fields: [categoryId], references: [id])
  orderItems OnlineOrderItem[]

  @@unique([storeId, slug])
  @@index([storeId])
  @@index([categoryId])
  @@index([isActive])
}

model OnlineOrder {
  id              String    @id @default(cuid())
  storeId         String
  orderNumber     String
  customerId      String?
  customerEmail   String
  customerName    String
  status          String    @default("PENDING") // PENDING, CONFIRMED, PROCESSING, SHIPPED, DELIVERED, CANCELLED
  paymentStatus   String    @default("PENDING") // PENDING, PAID, REFUNDED, FAILED
  paymentProvider String?   // STRIPE, PAYSTACK, FLUTTERWAVE, LEMONSQUEEZY, COD
  paymentReference String?  // External payment ID from provider
  paymentUrl      String?   // Redirect URL for payment
  subtotal        Decimal   @db.Decimal(15, 2)
  taxAmount       Decimal   @default(0) @db.Decimal(15, 2)
  shippingAmount  Decimal   @default(0) @db.Decimal(15, 2)
  discountAmount  Decimal   @default(0) @db.Decimal(15, 2)
  totalAmount     Decimal   @db.Decimal(15, 2)
  shippingAddress String?
  billingAddress  String?
  notes           String?
  paidAt          DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  store OnlineStore       @relation(fields: [storeId], references: [id], onDelete: Cascade)
  items OnlineOrderItem[]

  @@unique([storeId, orderNumber])
  @@index([storeId])
  @@index([status])
  @@index([customerEmail])
  @@index([paymentReference])
}

model OnlineOrderItem {
  id           String  @id @default(cuid())
  orderId      String
  productId    String
  productName  String
  sku          String?
  quantity     Int
  unitPrice    Decimal @db.Decimal(15, 2)
  totalPrice   Decimal @db.Decimal(15, 2)

  order   OnlineOrder   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product OnlineProduct @relation(fields: [productId], references: [id])

  @@index([orderId])
}

// ============================================
// PUBLIC FEEDBACK BOARD
// ============================================

model Feedback {
  id           String    @id @default(cuid())
  title        String
  description  String
  category     String    @default("FEATURE") // FEATURE, BUG, IMPROVEMENT, QUESTION
  status       String    @default("UNDER_REVIEW") // UNDER_REVIEW, PLANNED, IN_PROGRESS, COMPLETED, DECLINED
  priority     Int       @default(0) // For admin pinning/ordering
  isPinned     Boolean   @default(false)
  // Author info - supports both logged-in users and email-only guests
  authorEmail  String
  authorName   String
  authorUserId String?   // Clerk user ID if logged in
  // Voting tracking (denormalized for performance)
  voteCount    Int       @default(0)
  // Timestamps
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  votes   FeedbackVote[]
  replies FeedbackReply[]

  @@index([status])
  @@index([category])
  @@index([voteCount])
  @@index([createdAt])
  @@index([authorEmail])
}

model FeedbackVote {
  id         String   @id @default(cuid())
  feedbackId String
  // Voter info - email for guests, userId for logged-in
  voterEmail String
  voterUserId String?
  createdAt  DateTime @default(now())

  feedback Feedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)

  @@unique([feedbackId, voterEmail]) // One vote per email per feedback
  @@index([feedbackId])
  @@index([voterEmail])
}

model FeedbackReply {
  id         String   @id @default(cuid())
  feedbackId String
  content    String
  // Author must be logged in for replies
  authorName   String
  authorUserId String
  authorEmail  String
  isOfficial   Boolean  @default(false) // Is this from an admin/team member?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  feedback Feedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)

  @@index([feedbackId])
  @@index([createdAt])
}

